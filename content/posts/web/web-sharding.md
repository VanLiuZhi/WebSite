---
weight: 6600
title: "离散分片算法研究"
date: 2020-08-16T14:00:00+08:00
lastmod: 2020-08-16T14:00:00+08:00
draft: false
author: "VanLiuZhi"
authorLink: "https://www.liuzhidream.com"
description: "离散分片算法研究"
resources:
- name: "base-image"
  src: "/images/base-image.jpg"

tags: [Web, Note, Algorithm]
categories: [Clear-Mind]

lightgallery: true

toc:
  auto: false
---

## 一致性应该满足的标准

- 平衡性(Balance)

平衡性也就是说负载均衡，是指客户端hash后的请求应该能够分散到不同的服务器上去。一致性hash可以做到每个服务器都进行处理请求，但是不能保证每个服务器处理的请求的数量大致相同。

- 单调性(Monotonicity)

单调性是指如果已经有一些内容通过哈希分派到了相应的缓冲中，又有新的缓冲加入到系统中。哈希的结果应该能够保证已分配的内容可以被映射到新的缓冲中去，而不会被映射到旧的缓冲集合中的其他缓冲区。
比如，之前有三台服务器A、B、C，某个key被映射到B当中，当新增服务器D后，这个key要么被映射到之前的B中，要么被映射到新增的D中，而不应该映射到A或者C当中。

- 分散性(Spread)

分布式环境中，客户端请求时候可能不知道所有服务器的存在，可能只知道其中一部分服务器，在客户端看来他看到的部分服务器会形成一个完整的hash环。如果多个客户端都把部分服务器作为一个完整hash环，那么可能会导致，同一个用户的请求被路由到不同的服务器进行处理。这种情况显然是应该避免的，因为它不能保证同一个用户的请求落到同一个服务器。所谓分散性是指上述情况发生的严重程度。

- 负载(Load)

负载问题实际上是从另一个角度看待分散性问题。既然不同的终端可能将相同的内容映射到不同的缓冲区中，那么对于一个特定的缓冲区而言，也可能被不同的用户映射为不同的内容。与分散性一样，这种情况也是应当避免的，因此好的哈希算法应能够尽量降低缓冲的负荷。

## 知识点

- 公用哈希函数和哈希环

hash函数取值范围0, 2^32

- 节点(Node)映射至哈希环

节点就是服务器

- 对象(Object)映射于哈希环

对象就是要请求到服务器上的数据

- 对象(Object)映射至节点(Node)

请求和服务器对应关系

## 虚拟节点

节点数太少的时候，各节点映射的对象数量严重不均衡(数据倾斜)；相反，节点数越多越密集，数据在哈希环上的分布就越均匀
复制倍数为 2^32 时，就达到绝对的均匀，通常可取复制倍数为32或更高
虚拟节点哈希值的计算方法调整为：对“节点的IP(或机器名)+虚拟节点的序号(1~N)”作哈希

删除节点: 数据会映射到下一个节点上，原始节点是A，会映射到A的下一个节点
增加节点: 数据会映射到上一个节点上，原始节点是A，会映射到A的上一个节点

这里要考虑有虚节点的情况，通过来说增加和删除都是要把所有虚节点都去除的
